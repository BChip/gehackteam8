{"version":3,"sources":["editor-service/local-editor-service.ts"],"names":[],"mappings":"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","file":"local-editor-service.js","sourcesContent":["/**\n * @license\n * Copyright (c) 2015 The Polymer Project Authors. All rights reserved.\n * This code may only be used under the BSD style license found at\n * http://polymer.github.io/LICENSE.txt\n * The complete set of authors may be found at\n * http://polymer.github.io/AUTHORS.txt\n * The complete set of contributors may be found at\n * http://polymer.github.io/CONTRIBUTORS.txt\n * Code distributed by Google as part of the polymer project is also\n * subject to an additional IP rights grant found at\n * http://polymer.github.io/PATENTS.txt\n */\n\nimport {Analyzer, Options as AnalyzerOptions} from '../analyzer';\nimport {ParsedHtmlDocument} from '../html/html-document';\nimport {Attribute, Document, Element, Property, ScannedProperty, SourcePosition, SourceRange, Warning, WarningCarryingException} from '../model/model';\n\nimport {getLocationInfoForPosition} from './ast-from-source-position';\nimport {AttributeCompletion, EditorService, TypeaheadCompletion} from './editor-service';\n\nexport class LocalEditorService extends EditorService {\n  private _analyzer: Analyzer;\n  constructor(options: AnalyzerOptions) {\n    super();\n    this._analyzer = new Analyzer(options);\n  }\n\n  async fileChanged(localPath: string, contents?: string): Promise<void> {\n    await this._analyzer.analyze(localPath, contents);\n  }\n\n  async getDocumentationAtPosition(localPath: string, position: SourcePosition):\n      Promise<string|undefined> {\n    const feature = await this._getFeatureAt(localPath, position);\n    if (!feature) {\n      return;\n    }\n    if (isProperty(feature)) {\n      if (feature.type) {\n        return `{${feature.type}} ${feature.description}`;\n      }\n    }\n    return feature.description;\n  }\n\n  async getDefinitionForFeatureAtPosition(\n      localPath: string,\n      position: SourcePosition): Promise<SourceRange|undefined> {\n    const feature = await this._getFeatureAt(localPath, position);\n    if (!feature) {\n      return;\n    }\n    return feature.sourceRange;\n  }\n\n  async getTypeaheadCompletionsAtPosition(\n      localPath: string,\n      position: SourcePosition): Promise<TypeaheadCompletion|undefined> {\n    const document = await this._analyzer.analyze(localPath);\n    const location = await this._getLocationResult(document, position);\n    if (!location) {\n      return;\n    }\n    if (location.kind === 'tagName' || location.kind === 'text') {\n      const elements =\n          Array\n              .from(document.getByKind(\n                  'element', {imported: true, externalPackages: true}))\n              .filter((e) => e.tagName);\n      return {\n        kind: 'element-tags',\n        elements: elements.map((e) => {\n          const attributesSpace = e.attributes.length > 0 ? ' ' : '';\n          return {\n            tagname: e.tagName!,\n            description: e.description,\n            expandTo: location.kind === 'text' ?\n                `<${e.tagName}${attributesSpace}></${e.tagName}>` :\n                undefined\n          };\n        })\n      };\n    } else if (location.kind === 'attribute') {\n      const elements = document.getById(\n          'element',\n          location.element.nodeName,\n          {imported: true, externalPackages: true});\n      let attributes: AttributeCompletion[] = [];\n      for (const element of elements) {\n        // A map from the inheritedFrom to a sort prefix. Note that\n        // `undefined` is a legal value for inheritedFrom.\n        const sortPrefixes = new Map<string|undefined, string>();\n        // Not inherited, that means local! Sort it early.\n        sortPrefixes.set(undefined, 'aaa-');\n        if (element.superClass) {\n          sortPrefixes.set(element.superClass.identifier, 'bbb-');\n        }\n        if (element.extends) {\n          sortPrefixes.set(element.extends, 'ccc-');\n        }\n        const elementAttributes: AttributeCompletion[] =\n            element.attributes.map((p) => {\n              const sortKey =\n                  (sortPrefixes.get(p.inheritedFrom) || `ddd-`) + p.name;\n              return {\n                name: p.name,\n                description: p.description || '',\n                type: p.type,\n                inheritedFrom: p.inheritedFrom, sortKey\n              };\n            });\n\n        const eventAttributes: AttributeCompletion[] =\n            element.events.map((e) => {\n              const postfix = sortPrefixes.get(e.inheritedFrom) || 'ddd-';\n              const sortKey = `eee-${postfix}on-${e.name}`;\n              return {\n                name: `on-${e.name}`,\n                description: e.description || '',\n                type: e.type || 'CustomEvent',\n                inheritedFrom: e.inheritedFrom, sortKey\n              };\n            });\n        attributes =\n            attributes.concat(elementAttributes).concat(eventAttributes);\n      }\n      return {kind: 'attributes', attributes};\n    };\n  }\n\n  async getWarningsForFile(localPath: string): Promise<Warning[]> {\n    try {\n      const doc = await this._analyzer.analyze(localPath);\n      return doc.getWarnings({imported: false});\n    } catch (e) {\n      // This might happen if, e.g. `localPath` has a parse error. In that case\n      // we can't construct a valid Document, but we might still be able to give\n      // a reasonable warning.\n      if (e instanceof WarningCarryingException) {\n        const warnException: WarningCarryingException = e;\n        return [warnException.warning];\n      }\n      throw e;\n    }\n  }\n\n  async _clearCaches() {\n    this._analyzer.clearCaches();\n  }\n\n  private async _getFeatureAt(localPath: string, position: SourcePosition):\n      Promise<Element|Property|Attribute|undefined> {\n    const document = await this._analyzer.analyze(localPath);\n    const location = await this._getLocationResult(document, position);\n    if (!location) {\n      return;\n    }\n    if (location.kind === 'tagName') {\n      return document.getOnlyAtId(\n          'element',\n          location.element.nodeName,\n          {imported: true, externalPackages: true});\n    } else if (location.kind === 'attribute') {\n      const elements = document.getById(\n          'element',\n          location.element.nodeName,\n          {imported: true, externalPackages: true});\n      if (elements.size === 0) {\n        return;\n      }\n\n      return concatMap(elements, (el) => el.attributes)\n          .find((at) => at.name === location.attribute);\n    }\n  }\n\n  private async _getLocationResult(\n      document: Document, position: SourcePosition) {\n    const parsedDocument = document.parsedDocument;\n    if (!(parsedDocument instanceof ParsedHtmlDocument)) {\n      return;\n    }\n    return getLocationInfoForPosition(parsedDocument, position);\n  }\n}\n\n\n\nfunction isProperty(d: any): d is(ScannedProperty | Property) {\n  return 'type' in d;\n}\n\nfunction concatMap<I, O>(inputs: Iterable<I>, f: (i: I) => O[]): O[] {\n  let results: O[] = [];\n  for (const input of inputs) {\n    results = results.concat(f(input));\n  }\n  return results;\n}\n"]}